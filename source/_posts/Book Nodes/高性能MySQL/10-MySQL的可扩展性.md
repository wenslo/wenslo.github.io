---
title: MySQL的可扩展性

categories: 

- MySQL

tags: 

- MySQL
date: 2021-01-06 10:22:07
description: MySQL的可扩展性
---

扩展方式有两种

#### 向上扩展
____

加内存，选更强的CPU，加IO性能更强的设备。但是最好是MySQL的最新版本，不然的话，无法获得最好的性能。单服务器首先会达到读限制，特别是执行复杂的读查询时。类似这样的查询在MySQL内部是单线程的，因此只能使用一个CPU，这种情况下，加核心也无法提升多少性能，除非使用更快的CPU。当数据变得庞大以至于无法有效缓存时，内存也会成为瓶颈，通常表现为很高的磁盘使用率。

当主库升级到高端硬件后，一般是不太可能配制出一台能够跟上主库的强大备库的。一个高负载的主库通常可以承担比拥有同样的配置的备库更多的工作，因为备库的复制线程无法高效的利用多核CPU和磁盘资源。

#### 向外扩展
____

复制、拆分、数据分片

最简单的就是通过复制将数据分发到多个服务器上，然后将备库用于读查询。这种技术对于以读为主的应用很有效。但是也有一些缺点，例如重复缓存。

另一个常见的方法是将工作负载分布到多个节点。许多大型的MySQL应用不能自动分布负载，就算有也没有做到完全的自动化。在MySQL架构中，一个节点(node)就是一个功能部件。如果没有规划冗余和高可用性，那么一个节点就可能是一台服务器。如果设计的是能够故障转移的冗余系统，那么一个节点通常可能是下面的某一种：

- 一个主-主复制双机结构，拥有一个主动服务器和被动服务器
- 一个主库和多个备库
- 一个主动服务器，并使用分布式复制块设备（DRBD）作为备用服务器
- 一个基于存储区域网络（SAN）的集群

大多数情况下，一个节点内的所有服务器应该拥有相同的数据。我们倾向于把主-主复制架构作为两台服务器的主动-被动节点。

##### 1. 按功能拆分
____

按功能拆分，或者说按职责拆分，意味着不同的节点执行不同的任务。将独立的服务器或节点分配给不同的应用，这样每个节点只包含它的特定应用所需要的数据。如果应用很庞大，每个功能区域还可以拥有其专用的web服务器，但没有专用的数据库服务器这么常见。

另一个可能的按功能划分方法是对单个服务器的数据进行划分，并确保划分的表的集合之间不会执行关联操作。当必须执行关联操作时，如果对性能要求不高，可以在应用中做关联。虽然有一些变通的办法，但它们有一个共同点，就是每种类型的数据只能在单个节点上找到。这并不是一种通用的分布数据的方法，因为很难做到高效，并且相比其他方案没有任何优势。

归根结底，还是不能通过功能划分来无限的进行扩展，因为如果一个功能区域被捆绑到单个MySQL节点，就只能进行垂直扩展。其中的一个应用或者功能区域最终增长到非常庞大时，都会迫使你去寻求一个不同的策略。如果进行了太多的功能划分，以后就很难采用根据扩展性的设计了

##### 2. 数据分片
____

目前用于扩展大型MySQL应用的方案中，数据分片是最通用而且最成功的方法。它把数据分割成一小片，或者说一块，然后存储到不同的节点中。

数据分片在和某些类型的按功能划分联合使用时非常有用。大多数分片系统也有一些全局的数据不会被分片（城市列表，登录数据）。全局数据一般存储在单个节点上，并且通常保存在类似memcached这样的缓存里。

事实上，大多数应用只会对需要的数据做分片，通常是那些将会增长的非常庞大的数据。假设正在构建的博客服务，预计会有1000W用户，这时候就无须对注册用户进行分片，因为完全可将所有的用户放到内存中。假如用户达到5亿，那么就可能需要对用户数据分片。用户所产生的的内容。例如发表的文章和评论，几乎肯定需要进行数据分片，因为这些数据非常庞大，而且还会越来越多。

大型应用可能有多个逻辑数据集，并且处理方式也可以各不相同。可以将它们存储到不同的服务器组上，但这并不是必须的。还可以以多种方式对数据进行分片，这取决于如何使用他们。

分片技术和大多数应用的最初设计有着显著的差异，并且很难将应用从单一数据存储转换为分片架构。如果在应用设计出去就已经预计到分片，那实现起来就容易的多。

许多一开始没有建立分片架构的应用都会碰到规模扩大的情形。例如，可以使用复制来扩展博客服务的读查询，直到它不再奏效。然后可以把服务器划分为三个部分：用户信息，文章，以及评论。可以将这些数据放到不同的服务器上（按功能划分），也许可以使用面向服务的架构，并在应用层执行联合查询。

最后，可以通过用户ID来对文章和评论进行分片，而将用户信息保留在单个节点上。如果为全局节点配置一个主-备结构并为分片节点使用主-主结构，最终的数据可能如下图所示、

如果事先知道应用会扩大到很大的规模，并且清除按功能划分的局限性，就可以跳过中间步骤，直接从单个节点升级为分片数据存储。事实上，这种前瞻性可以帮你避免由于粗糙的分片方案带来的挑战。

采用分片的应用常会有一个数据库访问抽象层，用以降低应用和分片数据存储之间通信的复杂度，但无法完全隐藏分片。因为相比数据存储，应用通常更了解查询相关的一些信息。太多的抽象会导致低效率，例如查询所有的节点，可实际上需要的数据只在单一节点上。

分片数据存储看起来像是优雅的解决方案，但很难实现。那为啥要选择这个架构？因为：想扩展写容量，就必须切分数据。如果只有单台主库，那么不管有多少备库，写容量都是无法扩展的。对于上述缺点，数据分片是首选方案。

**如非必要，尽量不分片，首先看是否能通过性能调优或者更好的应用和数据库设计来推迟分片。如果能足够长时间的推迟分片，也许可以直接购买更大的服务器，升级MySQL到性能更优的版本，然后继续使用单台服务器，也可以增加或减少复制。**

**简单地说，对单台服务器而言，数据大小或写负载变得太大时，分片将会是不可避免的。如果不分片，而是尽可能的优化应用，系统能扩展到什么程度呢？答案可能会让你感到惊讶。有些非常受欢迎的应用，可能会以为一开始就分片了，但实际上知道已经值数十亿美元并且流量机器巨大也没有采用分片的设计。分片不是城里唯一的游戏，在没有必要的情况下，采用分片的架构来构建应用会步履维艰。**

##### 3. 选择分区键（partitioning key）
_____


