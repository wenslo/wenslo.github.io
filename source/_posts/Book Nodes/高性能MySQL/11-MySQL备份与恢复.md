---
title: MySQL的备份与恢复

categories: 

- MySQL

tags: 

- MySQL
date: 2021-01-10 16:03:36
description: MySQL的备份与恢复
---

### 1. 为什么要备份？
____

- 灾难恢复
- 领导改变想法
- 审计
- 测试

### 2. 定义备份需求
____

只有备份是不够的，还需要有一个恢复系统，但是，让备份系统平滑工作比构造良好的恢复过程和工具更容易。原因如下：

- 备份在先。只有已经做了备份才可能恢复，因此在构建系统时，注意力自然会集中到备份上
- 备份由脚本和任务自动完成。会花一些事件调优备份过程，但是天天同样重视恢复不可能。
- 备份是日常任务，恢复常常发生在危急情况下
- 因为安全的需要，如果正在做异地备份，可能需要对备份数据进行加密，或采取其他错误来进行保护。安全性往往只关注数据被盗用的结果，但是如果没有人能怼用来恢复数据的加密卷解锁，或者需要从一个整块的加密文件中抽取单个文件时，损害有多大？
- 只有一个人来规划、设计和实施备份。当灾难袭来时，那个人可能不在，因此需要培养几个人并有计划的互为备份，这样就不会要求一个不合格的人来恢复数据。

规划备份和恢复策略时，有两个重要的需求可以帮助思考：恢复点目标（PRO）和恢复时间目标（RTO）。它们定义了可以容忍丢失多少数据，以及需要等待多久将数据恢复。在定义PRO和RTO时，先尝试回答下面的问题：

- 不导致严重后果的情况下，可以容忍丢失多少数据？需要故障恢复，还是可以接受自从上次日常备份后所有的工作全部丢失？是否有法律法规的要求？
- 恢复需要在多长时间内完成？哪种类型的宕机是可接受的？哪种影响是应用和用户可以接受的？当哪些场景发生时，又该如何持续服务？
- 需要恢复什么？常见的是恢复整个服务器，单个数据库，单个表，或者仅仅是特定的事务或者语句

### 3 设计MySQL备份方案
_____

建议：

- 物理备份是必须的，逻辑备份太慢而且受到资源限制
- 保留多个备份集
- 定期从逻辑备份中抽取数据进行恢复测试
- 保存二进制日志以用于基于故障时间点的恢复，这样就可以在保持主库运行且不运行任何二进制日志的情况下创建一个备库。备库二进制日志与过期设置无关，二进制日志备份需要保存足够长的时间，以便能从最近的逻辑备份进行恢复
- 完全不借助备份工具来监控备份和备份的过程。另外需要验证备份是否正常
- 通过演练整个恢复过程来测试备份和恢复。测算需要的资源
- 对安全性仔细考虑

逻辑备份的优点：

- 逻辑备份可以用编辑器或者grep查看，当需要查看但不进行恢复的时候，很有帮助
- 恢复很简单
- 可以通过网络来恢复
- 很灵活，可以通过where 子句限制执行
- 与存储引擎无关
- 有助于避免数据损坏

缺点：

- 必须由数据库服务器完成逻辑备份的工作，因此需要更多的CPU时钟周期
- 逻辑本分某些场景下比数据库文件更大
- 无法保证导出后在还原一定是同样的数据
- 从逻辑悲愤中还原需要MySQL加载和解释语句，转换为存储格式，重建索引，很慢。

mysqldump 很有帮助。

物理备份的优点：

- 文件复制到其他地方即可完成备份
- 复制过去即可完成恢复，innodb需要停止服务
- 物理备份容易跨平台，操作系统，MySQL版本
- 恢复会更快

缺点：

- 原始文件比逻辑备份大很多，表空间有很多未使用的空间，缓冲，存储，回滚段等
- 物理备份不是总可以跨平台。


对于需要长期保留的备份，不要完全依赖于物理备份，每隔一段时间做一次逻辑备份。

建议混合使用，

#### 3.3 备份什么
_____

- 非显著数据，例如二进制日志，事务日志
- 代码，触发器，存储过程代码
- 配置复制，例如，二进制日志，中继日志，日志索引文件
- 服务器配置
- 操作系统文件

#### 3.4 存储引擎和一致性
____

数据一致性，应该考虑数据在指定时间点一致

文件一致性，例如，一条大的update语句执行时备份反映不出文件的状态。

### 4 管理和备份二进制日志
____

对于基于时间点的恢复是必须的，跟容易进行频繁的备份。经常备份二进制日志是个好主意。

